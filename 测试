-- ShadowEtcher 名字标签 + ESP 高亮
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local localPlayer = Players.LocalPlayer

-- 配置
local enabled = true
local scanInterval = 1.0
local fillTransparency = 0.6
local outlineTransparency = 0.0
local highlightColor = Color3.fromRGB(255, 100, 0)
local outlineColor = Color3.fromRGB(255, 255, 255)
local nameTextColor = Color3.fromRGB(255, 255, 255)
local nameTextSize = 18

local applied = {} -- 保存每个对象的 {Highlight, BillboardGui}

-- 为 BasePart 添加高亮
local function addHighlightToPart(part)
    if not part or not part:IsA("BasePart") then return nil end
    if applied[part] then return end
    local h = Instance.new("Highlight")
    h.Adornee = part
    h.Name = "ShadowEtcher_Highlight"
    h.Parent = part
    h.FillTransparency = fillTransparency
    h.OutlineTransparency = outlineTransparency
    h.FillColor = highlightColor
    h.OutlineColor = outlineColor
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    applied[part] = {Highlight = h}
    return h
end

-- 为模型添加高亮和名字标签
local function addHighlightAndNameToModel(model)
    if not model or applied[model] then return end
    local highlights = {}
    for _, descendant in ipairs(model:GetDescendants()) do
        if descendant:IsA("BasePart") then
            local h = addHighlightToPart(descendant)
            if h then table.insert(highlights, h) end
        end
    end
    -- 添加 BillboardGui 显示名字
    local headPart = model:FindFirstChild("Head") or model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
    if headPart then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ShadowEtcher_NameTag"
        billboard.Adornee = headPart
        billboard.Size = UDim2.new(0, 100, 0, 25)
        billboard.StudsOffset = Vector3.new(0, 3, 0) -- 在头顶上方
        billboard.AlwaysOnTop = true
        billboard.Parent = headPart

        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1,0,1,0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextColor3 = nameTextColor
        textLabel.TextStrokeTransparency = 0
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextScaled = true
        textLabel.Text = "ShadowEtcher"
        textLabel.Parent = billboard

        applied[model].Billboard = billboard
    end
    applied[model] = {Highlights = highlights, Billboard = applied[model] and applied[model].Billboard}
end

-- 移除高亮和名字标签
local function removeHighlightsForInstance(inst)
    if not inst then return end
    local data = applied[inst]
    if data then
        if data.Highlight then
            pcall(function() data.Highlight:Destroy() end)
        end
        if data.Highlights then
            for _, h in ipairs(data.Highlights) do
                pcall(function() h:Destroy() end)
            end
        end
        if data.Billboard then
            pcall(function() data.Billboard:Destroy() end)
        end
        applied[inst] = nil
    end
end

-- 判断目标对象
local function isTargetObject(obj)
    if not obj then return false end
    if obj:IsA("Model") and obj.Name == "ShadowEtcher" then return true end
    if obj:IsA("BasePart") and obj.Name == "ShadowEtcher" then return true end
    for _, d in ipairs(obj:GetDescendants()) do
        if d.Name == "ShadowEtcher" then return true end
    end
    return false
end

-- 扫描 Workspace
local function scanWorkspaceAndApply()
    if not enabled then return end
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if (obj:IsA("Model") or obj:IsA("BasePart")) and isTargetObject(obj) then
            if obj:IsA("Model") then
                addHighlightAndNameToModel(obj)
            else
                addHighlightToPart(obj)
            end
        end
    end
end

Workspace.DescendantAdded:Connect(function(desc)
    if not enabled then return end
    task.defer(function()
        if isTargetObject(desc) then
            if desc:IsA("Model") then
                addHighlightAndNameToModel(desc)
            elseif desc:IsA("BasePart") then
                addHighlightToPart(desc)
            end
        end
    end)
end)

Workspace.DescendantRemoving:Connect(function(desc)
    removeHighlightsForInstance(desc)
    for _, d in ipairs(desc:GetDescendants()) do
        removeHighlightsForInstance(d)
    end
end)

spawn(function()
    while true do
        if enabled then
            pcall(scanWorkspaceAndApply)
        else
            for inst, _ in pairs(applied) do
                removeHighlightsForInstance(inst)
            end
        end
        task.wait(scanInterval)
    end
end)

scanWorkspaceAndApply()
print("ShadowEtcher ESP + 名字标签已启动。")