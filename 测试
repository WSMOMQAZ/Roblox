-- ShadowEtcher ESP + 名字标签 "灰色斧"（多实例优化版）
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local localPlayer = Players.LocalPlayer

-- 配置
local enabled = true
local highlightColor = Color3.fromRGB(255, 100, 0)
local outlineColor = Color3.fromRGB(255, 255, 255)
local fillTransparency = 0.6
local outlineTransparency = 0.0
local nameTextColor = Color3.fromRGB(180, 180, 180)
local nameTextSize = 18
local fullModelHighlight = false -- 是否全模型高亮，false = 仅 Head/PrimaryPart

-- 保存每个 ShadowEtcher 的数据
local applied = {}

-- 为 BasePart 添加 Highlight
local function addHighlight(part)
    if not part or not part:IsA("BasePart") then return nil end
    local h = Instance.new("Highlight")
    h.Adornee = part
    h.Name = "ShadowEtcher_Highlight"
    h.Parent = part
    h.FillTransparency = fillTransparency
    h.OutlineTransparency = outlineTransparency
    h.FillColor = highlightColor
    h.OutlineColor = outlineColor
    h.DepthMode = Enum.HighlightDepthMode.Occluded
    return h
end

-- 为模型添加高亮和名字标签
local function addHighlightAndName(model)
    if not model or applied[model] then return end
    local highlights = {}

    if fullModelHighlight then
        for _, part in ipairs(model:GetDescendants()) do
            if part:IsA("BasePart") then
                table.insert(highlights, addHighlight(part))
            end
        end
    else
        local mainPart = model:FindFirstChild("Head") or model.PrimaryPart
        if mainPart then
            table.insert(highlights, addHighlight(mainPart))
        end
    end

    -- 添加名字标签
    local mainPart = model:FindFirstChild("Head") or model.PrimaryPart
    local billboard
    if mainPart then
        billboard = Instance.new("BillboardGui")
        billboard.Name = "ShadowEtcher_NameTag"
        billboard.Adornee = mainPart
        billboard.Size = UDim2.new(0, 100, 0, 25)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = mainPart

        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextColor3 = nameTextColor
        textLabel.TextStrokeTransparency = 0
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextSize = nameTextSize
        textLabel.Text = "灰色斧"
        textLabel.Parent = billboard
    end

    applied[model] = {Highlights = highlights, Billboard = billboard}
end

-- 移除高亮和名字标签
local function removeApplied(inst)
    if not inst then return end
    local data = applied[inst]
    if data then
        if data.Highlights then
            for _, h in ipairs(data.Highlights) do
                pcall(function() h:Destroy() end)
            end
        end
        if data.Billboard then
            pcall(function() data.Billboard:Destroy() end)
        end
        applied[inst] = nil
    end
end

-- 判断是否为 ShadowEtcher
local function isShadowEtcher(obj)
    if not obj then return false end
    if obj:IsA("Model") and obj.Name == "ShadowEtcher" then return true end
    if obj:IsA("BasePart") and obj.Name == "ShadowEtcher" then return true end
    return false
end

-- 监听新对象加入
Workspace.DescendantAdded:Connect(function(desc)
    if not enabled then return end
    task.defer(function()
        if isShadowEtcher(desc) and not applied[desc] then
            if desc:IsA("Model") then
                addHighlightAndName(desc)
            elseif desc:IsA("BasePart") then
                local h = addHighlight(desc)
                applied[desc] = {Highlights = {h}}
            end
        end
    end)
end)

-- 监听对象移除
Workspace.DescendantRemoving:Connect(function(desc)
    task.defer(function()
        removeApplied(desc)
    end)
end)

-- 启动时扫描已有对象
for _, obj in ipairs(Workspace:GetDescendants()) do
    if isShadowEtcher(obj) then
        if obj:IsA("Model") then
            addHighlightAndName(obj)
        elseif obj:IsA("BasePart") then
            local h = addHighlight(obj)
            applied[obj] = {Highlights = {h}}
        end
    end
end

print("ShadowEtcher ESP + 名字标签“灰色斧”（多实例版）已启动。")